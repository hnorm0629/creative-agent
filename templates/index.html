<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Creative Agent</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <h1 style="display: flex; align-items: center; gap: 0.5rem;">
    <img src="/static/icons/robot.svg" alt="Creative Agent" width="32" height="32">
    Creative Agent
  </h1>

  <form method="post" id="creative-form">
    <textarea name="input" id="input" rows="5" placeholder="Enter your creative brief...">{{ input or '' }}</textarea>
    <div class="button-row">
      <button id="submit-btn" type="submit">Generate Plan</button>
      <button id="surprise-btn" type="button" onclick="fetchSurprise()">Surprise Me</button>
      <button id="clear-btn" type="button">Clear</button>
    </div>
  </form>

  <!-- Loading animation -->
  <div id="loading" style="display: none; margin-top: 1rem;">Thinking<span id="dots">.</span></div>

  {% if plan %}
    <h2>Generated Plan</h2>
    <pre id="output">{{ plan }}</pre>
    <button type="button" id="copy-btn">Copy to Clipboard</button>
    <button type="button" id="download-btn">Download as JSON</button>
  {% elif error %}
    <p class="error">Error: {{ error }}</p>
  {% endif %}

  <script>
    // Clear input/output
    document.getElementById('clear-btn')?.addEventListener('click', () => {
      setButtonsDisabled(true);
      document.getElementById('input').value = '';
      document.getElementById('output')?.remove();
      document.getElementById('copy-btn')?.remove();
      document.getElementById('download-btn')?.remove();
      setButtonsDisabled(false);

      // Remove the generated plan header
      const header = document.querySelector('h2');
      if (header?.textContent === 'Generated Plan') {
        header.remove();
      }
    });

    // Disable or enable all form buttons
    function setButtonsDisabled(disabled) {
      document.querySelectorAll('.button-row button').forEach(btn => {
        btn.disabled = disabled;
        btn.classList.toggle('disabled', disabled); // Optional class to gray them out
      });
    }

    // Surprise Me button handler
    async function fetchSurprise() {
      const button = document.getElementById("surprise-btn");
      setButtonsDisabled(true);
      button.textContent = "Loading...";

      try {
        const res = await fetch('/surprise');
        const data = await res.json();
        document.getElementById('input').value = data.brief;
      } catch (err) {
        alert("Failed to load surprise brief!");
        console.error(err);
      } finally {
        button.textContent = "Surprise Me";
        setButtonsDisabled(false);
      }
    }

    // Copy to clipboard
    document.getElementById('copy-btn')?.addEventListener('click', () => {
      const text = document.getElementById('output')?.innerText;
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          alert("Copied to clipboard!");
        });
      }
    });

    // Download as JSON
    document.getElementById('download-btn')?.addEventListener('click', () => {
      const outputEl = document.getElementById('output');
      if (outputEl) {
        const content = outputEl.innerText;
        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        // Generate timestamp
        const now = new Date();
        const timestamp = now.toISOString().replace(/[:.]/g, '-');
        const filename = `creative_plan_${timestamp}.json`;

        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
    });

    // Loading animation on submit
    const form = document.getElementById('creative-form');
    form?.addEventListener('submit', () => {
      setButtonsDisabled(true);
      document.getElementById('loading').style.display = 'block';

      let dotCount = 1;
      const dotsEl = document.getElementById('dots');
      window.loadingInterval = setInterval(() => {
        dotCount = (dotCount % 3) + 1;
        dotsEl.textContent = '.'.repeat(dotCount);
      }, 500);
    });

    function clearError() {
      const errorEl = document.getElementById('error-message');
      if (errorEl) {
        errorEl.remove(); // or: errorEl.style.display = "none";
      }
    }

    // Attach to all interactive buttons
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      btn.addEventListener('click', clearError);
    });
  </script>
</body>
</html>
